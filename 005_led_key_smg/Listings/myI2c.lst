C251 COMPILER V5.60.0,  myI2c                                                              05/01/25  22:07:34  PAGE 1   


C251 COMPILER V5.60.0, COMPILATION OF MODULE myI2c
OBJECT MODULE PLACED IN .\Objects\myI2c.obj
COMPILER INVOKED BY: C:\Software\Keilv5\Keil\Core\C251\BIN\C251.EXE Driver\myI2c.c XSMALL BROWSE INCDIR(.\App;.\COMM;.\D
                    -river;.\User;..\005_) DEBUG PRINT(.\Listings\myI2c.lst) OBJECT(.\Objects\myI2c.obj) 

stmt  level    source

    1          /*      #   I2C代码片段说明
    2                  1.      本文件夹中提供的驱动代码供参赛选手完成程序设计参考。
    3                  2.      参赛选手可以自行编写相关代码或以该代码为基础，根据所选单片机类型、运行速度和试题
    4                          中对单片机时钟频率的要求，进行代码调试和修改。
    5          */
    6          #include "myI2c.h"
    7          sbit sda = P2^1;
    8          sbit scl = P2^0;
    9          #define DELAY_TIME      10
   10          void Delay5ms();
   11          //
   12          static void I2C_Delay(unsigned char n)
   13          {
   14   1              unsigned long edata i;
   15   1          do
   16   1          {
   17   2                      _nop_();
   18   2                      i = 6UL;
   19   2                      while (i) i--;
   20   2                      
   21   2          }
   22   1          while(n--);         
   23   1      }
   24          
   25          //
   26          void I2CStart(void)
   27          {
   28   1          sda = 1;
   29   1          scl = 1;
   30   1              I2C_Delay(DELAY_TIME);
   31   1          sda = 0;
   32   1              I2C_Delay(DELAY_TIME);
   33   1          scl = 0;    
   34   1      }
   35          
   36          //
   37          void I2CStop(void)
   38          {
   39   1          sda = 0;
   40   1          scl = 1;
   41   1              I2C_Delay(DELAY_TIME);
   42   1          sda = 1;
   43   1              I2C_Delay(DELAY_TIME);
   44   1      }
   45          
   46          //
   47          void I2CSendByte(unsigned char byt)
   48          {
   49   1          unsigned char i;
   50   1              
   51   1          for(i=0; i<8; i++){
   52   2              scl = 0;
   53   2                      I2C_Delay(DELAY_TIME);
   54   2              if(byt & 0x80){
   55   3                  sda = 1;
   56   3              }
   57   2              else{
   58   3                  sda = 0;
C251 COMPILER V5.60.0,  myI2c                                                              05/01/25  22:07:34  PAGE 2   

   59   3              }
   60   2                      I2C_Delay(DELAY_TIME);
   61   2              scl = 1;
   62   2              byt <<= 1;
   63   2                      I2C_Delay(DELAY_TIME);
   64   2          }
   65   1              
   66   1          scl = 0;  
   67   1      }
   68          
   69          //
   70          unsigned char I2CReceiveByte(void)
   71          {
   72   1              unsigned char da;
   73   1              unsigned char i;
   74   1              for(i=0;i<8;i++){   
   75   2                      scl = 1;
   76   2                      I2C_Delay(DELAY_TIME);
   77   2                      da <<= 1;
   78   2                      if(sda) 
   79   2                              da |= 0x01;
   80   2                      scl = 0;
   81   2                      I2C_Delay(DELAY_TIME);
   82   2              }
   83   1              return da;    
   84   1      }
   85          
   86          //
   87          unsigned char I2CWaitAck(void)
   88          {
   89   1              unsigned char ackbit;
   90   1              
   91   1          scl = 1;
   92   1              I2C_Delay(DELAY_TIME);
   93   1          ackbit = sda; 
   94   1          scl = 0;
   95   1              I2C_Delay(DELAY_TIME);
   96   1              
   97   1              return ackbit;
   98   1      }
   99          
  100          //
  101          void I2CSendAck(unsigned char ackbit)
  102          {
  103   1          scl = 0;
  104   1          sda = ackbit; 
  105   1              I2C_Delay(DELAY_TIME);
  106   1          scl = 1;
  107   1              I2C_Delay(DELAY_TIME);
  108   1          scl = 0; 
  109   1              sda = 1;
  110   1              I2C_Delay(DELAY_TIME);
  111   1      }
  112          
  113          void init_ad(u8 add)
  114          {
  115   1              I2CStart();
  116   1              I2CSendByte(0x90);
  117   1              I2CWaitAck();
  118   1              I2CSendByte(add);
  119   1              I2CWaitAck();
  120   1              I2CStop();
  121   1      
  122   1      }
  123          
  124          u8 read_ad()
C251 COMPILER V5.60.0,  myI2c                                                              05/01/25  22:07:34  PAGE 3   

  125          {
  126   1              u8 tmp;
  127   1              I2CStart();
  128   1              I2CSendByte(0x91);
  129   1              I2CWaitAck();
  130   1              tmp=I2CReceiveByte();
  131   1              I2CSendAck(1);
  132   1              I2CStop();
  133   1              return tmp;
  134   1      }
  135          
  136          void w_dac(u8 val)
  137          {
  138   1              I2CStart();
  139   1              I2CSendByte(0x90);
  140   1              I2CWaitAck();
  141   1              I2CSendByte(0x43);//单DAC 0x40  光敏+0x01  adc+0x03 
  142   1              I2CWaitAck();
  143   1              I2CSendByte(val);
  144   1              I2CWaitAck();
  145   1              I2CStop();
  146   1      }
  147          
  148          void w_e2p(u8 add,u8 val)
  149          {
  150   1              I2CStart();
  151   1              I2CSendByte(0xa0);
  152   1              I2CWaitAck();
  153   1              I2CSendByte(add);
  154   1              I2CWaitAck();
  155   1              I2CSendByte(val);
  156   1              I2CWaitAck();
  157   1              I2CStop();
  158   1      }
  159          
  160          u8 r_e2p(u8 add)
  161          {
  162   1              u8 tmp;
  163   1              I2CStart();
  164   1              I2CSendByte(0xa0);
  165   1              I2CWaitAck();
  166   1              I2CSendByte(add);
  167   1              I2CWaitAck();
  168   1              I2CStop();
  169   1      
  170   1              I2CStart();
  171   1              I2CSendByte(0xa1);
  172   1              I2CWaitAck();
  173   1              tmp=I2CReceiveByte();
  174   1              I2CSendAck(1);
  175   1              I2CStop();
  176   1              return tmp;
  177   1      }
  178          
  179          
  180          
  181          //***************
  182          void adc_proc()
  183          {
  184   1              cj.ad=read_ad();
  185   1              
  186   1              if(cj.ad>150)   
  187   1                      on(JDQ);
  188   1              else
  189   1                      off(JDQ);
  190   1              
C251 COMPILER V5.60.0,  myI2c                                                              05/01/25  22:07:34  PAGE 4   

  191   1              w_dac(cj.ad);
  192   1      }
  193          
  194          
  195          
  196          
  197          
  198          
  199          
  200          
  201          
  202          
  203          
  204          
  205          
  206          


Module Information          Static   Overlayable
------------------------------------------------
  code size            =       408     ------
  ecode size           =    ------     ------
  data size            =    ------     ------
  idata size           =    ------     ------
  pdata size           =    ------     ------
  xdata size           =    ------     ------
  xdata-const size     =    ------     ------
  edata size           =    ------     ------
  bit size             =    ------     ------
  ebit size            =    ------     ------
  bitaddressable size  =    ------     ------
  ebitaddressable size =    ------     ------
  far data size        =    ------     ------
  huge data size       =    ------     ------
  const size           =    ------     ------
  hconst size          =    ------     ------
End of Module Information.


C251 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
